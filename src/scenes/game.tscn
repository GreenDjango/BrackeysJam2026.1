[gd_scene format=3 uid="uid://c0bdtjmn1b4gh"]

[ext_resource type="PackedScene" uid="uid://bum3w3ougalos" path="res://src/entities/player.tscn" id="1_qfxj7"]

[sub_resource type="GDScript" id="GDScript_qfxj7"]
script/source = "extends Node3D

# todo: find a better shader value
# todo: merge CanvasLayer2 and CanvasLayer
# todo: properly rename node
func _input(event: InputEvent) -> void:
	var grain_shader = $CanvasLayer2/Grain.material
	var grain_size = grain_shader.get_shader_parameter(\"grain_size\")
	var grain_amount = grain_shader.get_shader_parameter(\"grain_amount\")
	if event.is_action_pressed(\"ui_cancel\"):
		if $Player.current_life > 0:
			grain_shader.set_shader_parameter(\"grain_size\", grain_size + 0.2)
			#grain_shader.set_shader_parameter(\"grain_amount\", grain_amount + 0.01)
	if event.is_action_pressed(\"ui_select\"):
		# fixme: use signal to avoid sync error as follow:
		#	1. Player._input -> $Player.current_life++
		#   2. (next line)   -> false
		# So, the original value of `grain_size` will be never meet. By using
		# \"signal\" or other sync features, we will be assured that an update
		# has been performed on the player life
		if $Player.current_life < $Player.max_life:
			grain_shader.set_shader_parameter(\"grain_size\", grain_size - 0.2)
			#grain_shader.set_shader_parameter(\"grain_amount\", grain_amount - 0.01)

func _process(delta: float) -> void:
	$Path3D/PathFollow3D.progress_ratio += delta / 20.0
"

[sub_resource type="Shader" id="Shader_covw0"]
code = "// Converted from https://www.shadertoy.com/view/td2GzW
shader_type canvas_item;
uniform sampler2D SCREEN_TEXTURE : hint_screen_texture, filter_linear_mipmap;

// Anti fish eye (negative amount) / fish eye (positive)
uniform float effect_amount : hint_range(-2.5, 2.5) = 1.0;

void fragment() {
	// glsl -> godot shader
	vec2 iResolution = 1.0 / SCREEN_PIXEL_SIZE;
	vec4 fragCoord = FRAGCOORD;

	//normalized coords 
	vec2 p = fragCoord.xy / iResolution.x;

	//screen proroption
	float prop = iResolution.x / iResolution.y;

	//center coords
	vec2 m = vec2(0.5, 0.5 / prop);

	//vector from center to current fragment
	vec2 d = p - m;

	// distance of pixel from center
	float r = sqrt(dot(d, d)); 

	float power = effect_amount;

	//radius of 1:1 effect
	float bind;
	
	//stick to borders
	if (power > 0.0) 
		bind = sqrt(dot(m, m));
	else {
		if (prop < 1.0) 
    		bind = m.x; 
    	else 
        	bind = m.y;
	}

	vec2 uv;
	//fisheye
	if (power > 0.0)
		uv = m + normalize(d) * tan(r * power) * bind / tan( bind * power);
	//antifisheye
	else if (power < 0.0)
		uv = m + normalize(d) * atan(r * -power * 10.0) * bind / atan(-power * bind * 10.0);
	//no effect for power = 1.0
	else
		uv = p;
    uv.y *= prop;

	vec3 col = texture(SCREEN_TEXTURE, uv).rgb;
    
	COLOR = vec4(col, 1.0);
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_3rtjt"]
shader = SubResource("Shader_covw0")
shader_parameter/effect_amount = 1.6040001949400002

[sub_resource type="ProceduralSkyMaterial" id="ProceduralSkyMaterial_qfxj7"]
sky_top_color = Color(1, 0.47018713, 0.39553028, 1)
sky_horizon_color = Color(0.9252929, 0.7850897, 0.7574254, 1)
ground_horizon_color = Color(0.9252929, 0.7850897, 0.7574254, 1)

[sub_resource type="Sky" id="Sky_covw0"]
sky_material = SubResource("ProceduralSkyMaterial_qfxj7")

[sub_resource type="Environment" id="Environment_3rtjt"]
background_mode = 2
sky = SubResource("Sky_covw0")
ssao_enabled = true
glow_enabled = true

[sub_resource type="GDScript" id="GDScript_covw0"]
script/source = "extends SpringArm3D

@export var mouse_sensibility: float = 0.0005
@export_range(-90.0, 0.0, 0.1, \"radians_as_degrees\") var min_vertical_angle: float = -PI/2
@export_range(0.0, 90.0, 0.1, \"radians_as_degrees\") var max_vertical_angle: float = PI/4

func _ready() -> void:
	#Input.set_mouse_mode(Input.MOUSE_MODE_CAPTURED)
	pass

func _unhandled_input(event: InputEvent) -> void:
	if event is InputEventMouseMotion:
		rotation.y -= event.relative.x * mouse_sensibility
		rotation.y = wrapf(rotation.y, 0.0, TAU)

		rotation.x -= event.relative.y * mouse_sensibility
		rotation.x = clamp(rotation.x, min_vertical_angle, max_vertical_angle)
"

[sub_resource type="Curve3D" id="Curve3D_qfxj7"]
closed = true
_data = {
"points": PackedVector3Array(0, 0, 0, 0, 0, 0, 13.69969, 2.5061684, -9.705795, 0, 0, 0, 0, 0, 0, 29.863, 2.506, -10.551, 0, 0, 0, 0, 0, 0, 31.943, 2.506, -19.371, 0, 0, 0, 0, 0, 0, 28.059, 2.506, -26.948, 0, 0, 0, 0, 0, 0, 17.588, 2.506, -28.538, 0, 0, 0, 0, 0, 0, 9.004, 2.506, -28.321, 0, 0, 0, 0, 0, 0, 3.406, 2.506, -23.216, 0, 0, 0, 0, 0, 0, -3.559, 2.506, -17.606, 0, 0, 0, 0, 0, 0, -12.736, 2.506, -13.457, 0, 0, 0, 0, 0, 0, -26.731585, 4.625519, -9.2014065, 0, 0, 0, 0, 0, 0, -32.453545, 5.903839, -11.865137, 0, 0, 0, 0, 0, 0, -36.605232, 8.695938, -18.28857, 0, 0, 0, 0, 0, 0, -34.29055, 10.94981, -23.884663, 0, 0, 0, 0, 0, 0, -24.19964, 12.160839, -27.53313, 0, 0, 0, 0, 0, 0, -15.900351, 12.127201, -28.053982, 0, 0, 0, 0, 0, 0, -8.443341, 9.906979, -23.247559, 0, 0, 0, 0, 0, 0, -4.2986116, 8.662308, -20.550453, 0, 0, 0, 0, 0, 0, -1.8619584, 7.1148796, -17.134335, 0, 0, 0, 0, 0, 0, 1.6157899, 5.197418, -12.875996),
"tilts": PackedFloat32Array(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
}
point_count = 19

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_qfxj7"]

[sub_resource type="SphereMesh" id="SphereMesh_qfxj7"]
material = SubResource("StandardMaterial3D_qfxj7")
radius = 5.0
height = 10.0

[sub_resource type="SphereShape3D" id="SphereShape3D_qfxj7"]
radius = 5.0

[sub_resource type="PlaneMesh" id="PlaneMesh_qfxj7"]
size = Vector2(10, 10)

[sub_resource type="BoxShape3D" id="BoxShape3D_covw0"]
size = Vector3(100, 1, 100)

[sub_resource type="Shader" id="Shader_qfxj7"]
code = "shader_type canvas_item;

uniform sampler2D screen_texture : hint_screen_texture;
uniform float grain_amount : hint_range(0.0, 1.0) = 0.05; // Adjust the amount of grain
uniform float grain_size : hint_range(0.1, 10.0) = 1.0; // Adjust the size of the grain
uniform bool animate = false;

void fragment() {
	// Sample the original screen texture
	vec4 original_color = texture(screen_texture, SCREEN_UV);
	
	float noise = 0.0;
	
	if (animate) {
		// Generate random noise
		noise = (fract(sin(dot(UV * TIME, vec2(12.9898, 78.233))) * 43758.5453) - 0.5) * 2.0;
	} else {
		 noise = (fract(sin(dot(UV, vec2(12.9898, 78.233))) * 43758.5453) - 0.5) * 2.0;
	}
	// Add noise to the original color
	original_color.rgb += noise * grain_amount * grain_size;
	
	// Clamp the final color to make sure it stays in the valid range
	COLOR = clamp(original_color, 0.0, 1.0);
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_covw0"]
shader = SubResource("Shader_qfxj7")
shader_parameter/grain_amount = 0.050000002375
shader_parameter/grain_size = 1.0
shader_parameter/animate = false

[node name="Game" type="Node3D" unique_id=664495583]
script = SubResource("GDScript_qfxj7")

[node name="CanvasLayer" type="CanvasLayer" parent="." unique_id=890081452]

[node name="BodyCam" type="ColorRect" parent="CanvasLayer" unique_id=959627027]
material = SubResource("ShaderMaterial_3rtjt")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(1, 1, 1, 0)

[node name="WorldEnvironment" type="WorldEnvironment" parent="." unique_id=750896921]
environment = SubResource("Environment_3rtjt")

[node name="Player" parent="." unique_id=460088547 instance=ExtResource("1_qfxj7")]

[node name="SpringArm3D" type="SpringArm3D" parent="Player" unique_id=1792243068]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 4.13955, 0.65444064)
spring_length = 8.0
script = SubResource("GDScript_covw0")

[node name="Camera3D" type="Camera3D" parent="Player/SpringArm3D" unique_id=391964210]

[node name="Path3D" type="Path3D" parent="." unique_id=1417264825]
curve = SubResource("Curve3D_qfxj7")

[node name="PathFollow3D" type="PathFollow3D" parent="Path3D" unique_id=1580898727]
transform = Transform3D(-0.31870916, -0.065658584, -0.945563, -0.75317967, 0.62318164, 0.21058984, 0.57543856, 0.7793042, -0.2480675, 13.699693, 2.5061686, -9.705795)
progress = 171.78822

[node name="Boule3D" type="AnimatableBody3D" parent="Path3D/PathFollow3D" unique_id=1910222882]
sync_to_physics = false

[node name="MeshInstance3D" type="MeshInstance3D" parent="Path3D/PathFollow3D/Boule3D" unique_id=902182902]
transform = Transform3D(1.0000088, 0, 0, 5.9604645e-08, 1.0000058, -1.4901161e-08, 0, -2.9802322e-08, 1.0000037, 0, 0, 0)
layers = 3
mesh = SubResource("SphereMesh_qfxj7")

[node name="CollisionShape3D" type="CollisionShape3D" parent="Path3D/PathFollow3D/Boule3D" unique_id=1884811548]
shape = SubResource("SphereShape3D_qfxj7")

[node name="Ground" type="StaticBody3D" parent="." unique_id=1429971742]

[node name="MeshInstance3D" type="MeshInstance3D" parent="Ground" unique_id=1216062309]
transform = Transform3D(10, 0, 0, 0, 10, 0, 0, 0, 10, 0, 0, 0)
mesh = SubResource("PlaneMesh_qfxj7")

[node name="CollisionShape3D" type="CollisionShape3D" parent="Ground" unique_id=398013267]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -0.4995, 0)
shape = SubResource("BoxShape3D_covw0")

[node name="CanvasLayer2" type="CanvasLayer" parent="." unique_id=1649531986]

[node name="Grain" type="ColorRect" parent="CanvasLayer2" unique_id=781885694]
material = SubResource("ShaderMaterial_covw0")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(1, 1, 1, 0)
