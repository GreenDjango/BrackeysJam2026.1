[gd_scene format=3 uid="uid://cj34dbpemxdu4"]

[ext_resource type="PackedScene" uid="uid://bhmrmut1jjhoo" path="res://src/utils/fps.tscn" id="1_wqv08"]

[sub_resource type="GDScript" id="GDScript_6oaa7"]
script/source = "extends Node3D

const Y_OFFSET := 0.51

var draggingCollider: Node3D
var draggingPosition: Vector3
var doDrag := false

func _process(_delta: float) -> void:
	if draggingCollider:
		draggingCollider.global_position = draggingPosition + Vector3(0,Y_OFFSET,0)

func _input(event):
	var intersect: Dictionary

	if event is InputEventMouse:
		var currentCamera := get_viewport().get_camera_3d()
		var params := PhysicsRayQueryParameters3D.new()

		params.from = currentCamera.project_ray_origin(event.position)
		params.to = currentCamera.project_position(event.position, 1000)
		if draggingCollider: params.exclude = [draggingCollider]
		
		var worldspace := get_world_3d().direct_space_state
		intersect = worldspace.intersect_ray(params)
		if intersect: draggingPosition = intersect[\"position\"] 
		#snap on collider
		#if intersect: draggingPosition = intersect.[\"collider\"].global_position

	if event is InputEventMouseButton:
		var leftButtonPressed = event.button_index == MOUSE_BUTTON_LEFT && event.pressed
		var leftButtonReleased = event.button_index == MOUSE_BUTTON_LEFT && !event.pressed
		var canMove = intersect && intersect[\"collider\"] in get_tree().get_nodes_in_group(\"moveable\")

		if leftButtonPressed && canMove:
			doDrag = true
			draggingCollider = intersect[\"collider\"]
		elif leftButtonReleased:
			doDrag = false
			draggingCollider = null
"

[sub_resource type="ProceduralSkyMaterial" id="ProceduralSkyMaterial_ge2is"]
sky_horizon_color = Color(0.66224277, 0.6717428, 0.6867428, 1)
ground_horizon_color = Color(0.66224277, 0.6717428, 0.6867428, 1)

[sub_resource type="Sky" id="Sky_wqv08"]
sky_material = SubResource("ProceduralSkyMaterial_ge2is")

[sub_resource type="Environment" id="Environment_6oaa7"]
background_mode = 2
sky = SubResource("Sky_wqv08")
tonemap_mode = 2

[sub_resource type="GDScript" id="GDScript_1p0ui"]
script/source = "extends CharacterBody3D

const SPEED := 5.0
const JUMP_VELOCITY := 10.0
const WEIGHT := 2.0
const WALK_BLEND_SPEED := 0.05

var idle_time := 0.0
var max_life : int = 5
var current_life : int = max_life
var tired_stat : int = 100
var fear_stat : int = 100

func _ready() -> void:
	pass

func _process(delta: float) -> void:
	if not velocity:
		idle_time += delta
	else:
		idle_time = 0
		
	var params := PhysicsRayQueryParameters3D.new()
	params.from = global_position
	params.to = global_position + Vector3(0, -1000, 0)
	params.exclude = [self]

	var worldspace := get_world_3d().direct_space_state
	var intersect := worldspace.intersect_ray(params)
	if intersect:
		$Shadow.global_position = intersect[\"position\"]
		$Shadow.mesh.radius = lerp(0.0, 0.5, 1 - clamp(global_position.y - intersect[\"position\"].y, 0, 10) / 10.0)

func _physics_process(delta: float) -> void:
	# Add the gravity.
	if not is_on_floor():
		velocity += get_gravity() * delta * WEIGHT

	# Handle jump.
	if Input.is_action_just_pressed(\"ui_accept\") and is_on_floor():
		velocity.y = JUMP_VELOCITY

	# Get the input direction and handle the movement/deceleration.
	# As good practice, you should replace UI actions with custom gameplay actions.
	var input_dir := Input.get_vector(\"left\", \"right\", \"up\", \"down\")
	var direction := (transform.basis * Vector3(input_dir.x, 0, input_dir.y)).normalized()
	if direction:
		velocity.x = direction.x * SPEED
		velocity.z = direction.z * SPEED
	else:
		velocity.x = move_toward(velocity.x, 0, SPEED)
		velocity.z = move_toward(velocity.z, 0, SPEED)

	move_and_slide()

func _input(event: InputEvent) -> void:
	if event.is_action_pressed(\"ui_cancel\"):
		remove_life()

func remove_life() -> void:
	if current_life > 0:
		current_life = current_life - 1
		var progress_to_death := 1 - current_life / float(max_life)
		$Torche/MeshInstance3D.mesh.material.albedo_color -= Color(progress_to_death,0,0,0)
"

[sub_resource type="CapsuleShape3D" id="CapsuleShape3D_ge2is"]
height = 4.1674805

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_ge2is"]
transparency = 1
albedo_color = Color(0, 0, 0, 0.7921569)

[sub_resource type="SphereMesh" id="SphereMesh_ge2is"]
material = SubResource("StandardMaterial3D_ge2is")
height = 0.01
is_hemisphere = true

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_wqv08"]
transparency = 1
albedo_color = Color(1, 0, 0, 0.5764706)

[sub_resource type="SphereMesh" id="SphereMesh_wqv08"]
material = SubResource("StandardMaterial3D_wqv08")

[sub_resource type="GDScript" id="GDScript_wqv08"]
script/source = "extends Camera3D

enum CAMERA_TYPE {
	Walk,
	Drag
}

const TRANSITION_DURATION = 0.8

var camera_type := CAMERA_TYPE.Walk
var tween: Tween

func _ready() -> void:
	position = $\"../WalkCameraMarker\".position
	rotation = $\"../WalkCameraMarker\".rotation

func _input(event: InputEvent) -> void:
	if event.is_action_pressed(\"ui_copy\"):
		#print(get_tree().get_processed_tweens())
		if tween: tween.stop()
		tween = create_tween().set_parallel(true).set_ease(Tween.EASE_IN_OUT)
		if camera_type == CAMERA_TYPE.Walk:
			camera_type = CAMERA_TYPE.Drag
			tween.tween_property($\".\", \"position\", $\"../DragCameraMarker\".position, TRANSITION_DURATION)
			tween.tween_property($\".\", \"rotation\", $\"../DragCameraMarker\".rotation, TRANSITION_DURATION)
		elif camera_type == CAMERA_TYPE.Drag:
			camera_type = CAMERA_TYPE.Walk
			tween.tween_property($\".\", \"position\", $\"../WalkCameraMarker\".position, TRANSITION_DURATION)
			tween.tween_property($\".\", \"rotation\", $\"../WalkCameraMarker\".rotation, TRANSITION_DURATION)
"

[sub_resource type="BoxShape3D" id="BoxShape3D_6oaa7"]
size = Vector3(3, 2, 3)

[sub_resource type="BoxShape3D" id="BoxShape3D_ge2is"]
size = Vector3(5, 0.5, 12)

[sub_resource type="BoxShape3D" id="BoxShape3D_wqv08"]
size = Vector3(5, 0.5, 10)

[sub_resource type="WorldBoundaryShape3D" id="WorldBoundaryShape3D_x87t7"]

[sub_resource type="ConvexPolygonShape3D" id="ConvexPolygonShape3D_ge2is"]
points = PackedVector3Array(0, 0, 0, 5, 0, 0, 5, 5, -10, 0, 5, -10, 0, 0, -10, 5, 0, -10)

[sub_resource type="BoxShape3D" id="BoxShape3D_1p0ui"]
size = Vector3(5, 6.5, 1)

[sub_resource type="BoxShape3D" id="BoxShape3D_xhygl"]
size = Vector3(5, 1, 5)

[sub_resource type="BoxShape3D" id="BoxShape3D_px3je"]
size = Vector3(5, 1, 5)

[node name="DemoTheo" type="Node3D" unique_id=626074131]
script = SubResource("GDScript_6oaa7")

[node name="WorldEnvironment" type="WorldEnvironment" parent="." unique_id=1136327216]
environment = SubResource("Environment_6oaa7")

[node name="Fps" parent="." unique_id=50958211 instance=ExtResource("1_wqv08")]

[node name="DragCameraMarker" type="Marker3D" parent="Fps" unique_id=713670042]
transform = Transform3D(1, 0, 0, 0, 0.9396926, 0.34202012, 0, -0.34202012, 0.9396926, 0, 15, 15)

[node name="Player" type="CharacterBody3D" parent="." unique_id=889598580]
script = SubResource("GDScript_1p0ui")

[node name="CollisionShape3D" type="CollisionShape3D" parent="Player" unique_id=333433114]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 2.0837402, 0)
shape = SubResource("CapsuleShape3D_ge2is")
debug_color = Color(1, 1, 1, 0.41960785)

[node name="Shadow" type="MeshInstance3D" parent="Player" unique_id=2092401130]
mesh = SubResource("SphereMesh_ge2is")

[node name="Torche" type="Node3D" parent="Player" unique_id=855711736]

[node name="MeshInstance3D" type="MeshInstance3D" parent="Player/Torche" unique_id=1312859873]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 3, -1)
mesh = SubResource("SphereMesh_wqv08")

[node name="Camera" type="Node3D" parent="Player" unique_id=977549732]

[node name="WalkCameraMarker" type="Marker3D" parent="Player/Camera" unique_id=1324063835]
transform = Transform3D(1, 0, 0, 0, 0.9396926, 0.34202012, 0, -0.34202012, 0.9396926, 0, 9, 8)

[node name="DragCameraMarker" type="Marker3D" parent="Player/Camera" unique_id=988869775]
transform = Transform3D(1, 0, 0, 0, 0.49999994, 0.8660254, 0, -0.8660254, 0.49999994, 0, 17, 1.5)

[node name="Camera3D" type="Camera3D" parent="Player/Camera" unique_id=297672218]
transform = Transform3D(1, 0, 0, 0, 0.9396927, 0.34202015, 0, -0.34202015, 0.9396927, 0, 9, 8)
script = SubResource("GDScript_wqv08")

[node name="Cube" type="RigidBody3D" parent="." unique_id=1978552911 groups=["moveable"]]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 10, 1, 0)

[node name="CollisionShape3D" type="CollisionShape3D" parent="Cube" unique_id=1614030129]
shape = SubResource("BoxShape3D_6oaa7")

[node name="Bridge" type="RigidBody3D" parent="." unique_id=1847780758 groups=["moveable"]]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 10, 1, -25)
collision_layer = 129
collision_mask = 129

[node name="CollisionShape3D" type="CollisionShape3D" parent="Bridge" unique_id=302584937]
shape = SubResource("BoxShape3D_ge2is")

[node name="BridgePlaceholder" type="StaticBody3D" parent="." unique_id=164752920]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 2.5, 4.75, -25)
collision_layer = 128
collision_mask = 128

[node name="CollisionShape3D" type="CollisionShape3D" parent="BridgePlaceholder" unique_id=333487739]
shape = SubResource("BoxShape3D_wqv08")

[node name="Ground" type="StaticBody3D" parent="." unique_id=659536063]

[node name="CollisionShape3D" type="CollisionShape3D" parent="Ground" unique_id=219146566]
shape = SubResource("WorldBoundaryShape3D_x87t7")

[node name="Rampe1" type="CollisionShape3D" parent="Ground" unique_id=1450959461]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, -10)
shape = SubResource("ConvexPolygonShape3D_ge2is")

[node name="Rampe2" type="CollisionShape3D" parent="Ground" unique_id=184645138]
transform = Transform3D(-1, 0, -8.742278e-08, 0, 1, 0, 8.742278e-08, 0, -1, 5, 0, -40)
shape = SubResource("ConvexPolygonShape3D_ge2is")

[node name="Wall1" type="CollisionShape3D" parent="Ground" unique_id=1846891921]
transform = Transform3D(-4.371139e-08, 0, 1, 0, 1, 0, -1, 0, -4.371139e-08, 15, 3.3000002, -6)
shape = SubResource("BoxShape3D_1p0ui")

[node name="Wall2" type="CollisionShape3D" parent="Ground" unique_id=1765452214]
transform = Transform3D(-4.371139e-08, 0, 1, 0, 1, 0, -1, 0, -4.371139e-08, 12, 4, -6)
shape = SubResource("BoxShape3D_xhygl")

[node name="Wall3" type="CollisionShape3D" parent="Ground" unique_id=2128502056]
transform = Transform3D(-4.371139e-08, 0, 1, 0, 1, 0, -1, 0, -4.371139e-08, 18, 6, -6)
shape = SubResource("BoxShape3D_px3je")
